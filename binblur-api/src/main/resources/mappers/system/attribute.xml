<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.binblur.mapper.attribute">

    <sql id="attributeColumns">
          ID                     AS id
        , ATTR_NAME              AS attrNm
        , ATTR_ENG_NAME          AS attrEngNm
        , ATTR_TYPE              AS attrType
        , ATTR_CAT               AS attrCat
        , ATTR_DESC              AS attrDesc
        , CODE_UPPER             As codeUpper
        , CRE_TM                 AS createDateTime
        , CRE_USER               AS createUser
        , UPD_TM                 AS updateDateTime
        , UPD_USER               AS updateUser
        , DEL_YN                 AS deleteYn
    </sql>

    <select id="selectAttributeListPaging" parameterType="com.binblur.core.biz.system.vo.request.AttributeRequest" resultType="com.binblur.core.biz.system.vo.response.AttributeResponse$Paging">
        SELECT
        <include refid="attributeColumns" />
        ,(SELECT USER_NM FROM TB_USER X WHERE  A.CRE_USER=X.LOGIN_ID) AS creNm
        ,(SELECT USER_NM FROM TB_USER X WHERE  A.UPD_USER=X.LOGIN_ID) AS updNm
        ,(SELECT COUNT(*) FROM TB_CODE X WHERE X.CODE_UPPER = A.CODE_UPPER) AS totalRowCount
        , ROW_NUMBER() OVER(ORDER BY A.ID ASC)             AS no
        FROM TB_ATTR A
        WHERE 1 = 1
        AND A.DEL_YN = 'N'
        <if test='filter.attrNm != null and !filter.attrNm.equals("")'>
            AND A.ATTR_NAME LIKE CONCAT('%' ,#{filter.attrNm} ,'%')
        </if>
        <if test='filter.attrEngNm != null and !filter.attrEngNm.equals("")'>
            AND A.ATTR_ENG_NAME LIKE CONCAT('%' ,#{filter.attrEngNm} ,'%')
        </if>
        <if test='filter.attrType != null and !filter.attrType.equals("")'>
            AND A.ATTR_TYPE LIKE CONCAT('%' ,#{filter.attrType} ,'%')
        </if>
        <if test='filter.attrCat != null and !filter.attrCat.equals("")'>
            AND A.ATTR_CAT LIKE CONCAT('%' ,#{filter.attrCat} ,'%')
        </if>
    </select>

    <!--forEach 사용하는 관계로 test 구문을 통해 필드 값이 null 인 경우에 대응하는 로직 사용이 곤란-->
    <insert id="insertAttribute" parameterType="List">
        INSERT INTO TB_ATTR
        (
             ATTR_NAME
            ,ATTR_ENG_NAME
            ,ATTR_TYPE
            ,ATTR_CAT
            ,ATTR_DESC
            ,CODE_UPPER
            ,CRE_USER
        )
        VALUES
        <foreach collection="list" item="insert" separator=",">
            (
             #{insert.attrNm}
            ,#{insert.attrEngNm}
            ,#{insert.attrType}
            ,#{insert.attrCat}
            ,#{insert.attrDesc}
            ,#{insert.codeUpper}
            ,#{insert.createUser}
            )
        </foreach>
    </insert>

    <!--forEach 사용하는 관계로 test 구문을 통해 필드 값이 null 인 경우에 대응하는 로직 사용이 곤란-->
    <update id="updateAttribute" parameterType="List">
        <foreach collection="list" item="update" separator=";">
            /* com.binblur.mapper.attribute.updateAttribute */
            UPDATE TB_ATTR
            SET
                  UPD_TM   = CURRENT_TIMESTAMP,
                  UPD_USER = #{update.updateUser}
                , ATTR_NAME = #{update.attrNm}
                , ATTR_ENG_NAME = #{update.attrEngNm}
                , ATTR_TYPE = #{update.attrType}
                , ATTR_CAT = #{update.attrCat}
                , ATTR_DESC = #{update.attrDesc}
                , DEL_YN = #{update.deleteYn}
            WHERE ID = #{update.id}
        </foreach>
    </update>
</mapper>
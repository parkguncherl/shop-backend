<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.binblur.mapper.order">
    <!-- 초기 랜더링을 위한 조회 쿼리가 존재하지 않음, 추후 검색이 이루어질 시 조건 바탕으로 조회-->
    <sql id="orderColumns">
          SKU_NM AS skuNm
        , SKU_CD AS skuCd
        , SKU_SIZE AS skuSize
        , SKU_COLOR AS skuColor
        , SELL_AMT AS sellAmt
    </sql>

    <select id="selectOrderListPaging" parameterType="com.binblur.core.biz.system.vo.request.OrderRequest" resultType="com.binblur.core.biz.system.vo.response.OrderResponse$Paging">
        /* com.binblur.mapper.order.selectOrderListPaging */
        SELECT
        A.ID     AS id,
        <include refid="orderColumns" />
        , COUNT(B.ID) AS inventoryAmt
        , ROW_NUMBER() OVER(ORDER BY A.ID ASC)             AS no
        FROM TB_SKU A
        JOIN TB_PROD C ON A.PROD_ID = C.ID
        LEFT OUTER JOIN TB_INVEN B ON  A.ID = B.SKU_ID AND B.INVEN_STAT_CD ='A'
        WHERE C.PARTNER_ID = 1
        <if test='filter.skuNm != null and !filter.skuNm.equals("")'>
            AND A.SKU_NM LIKE concat('%', #{filter.skuNm}, '%')
        </if>
        GROUP BY A.ID, A.SKU_NM, A.SKU_CD, A.SKU_SIZE, A.SKU_COLOR, A.SELL_AMT
        <if test='filter.inventoryAmt != null and !filter.inventoryAmt.equals("")'>
            HAVING COUNT(B.ID) = #{filter.inventoryAmt}::INTEGER
        </if>
        ORDER BY A.ID DESC;
    </select>
</mapper>
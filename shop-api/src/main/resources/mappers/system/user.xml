<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.mapper.user">

    <sql id="userColumns">
         ID                    AS id,                  /* 아이디(pk)    */
         LOGIN_ID              AS loginId,             /* 로그인 아이디  */
         LOGIN_PASS            AS loginPass,           /* 로그인 비밀번호  */
         USER_NM               AS userNm,              /* 사용자명  */
         AUTH_CD               AS authCd,              /* 권한 코드  */
         PARTNER_ID            AS partnerId,           /* 파트너 ID  */
         PHONE_NO              AS phoneNo,             /* 전화번호  */
         BELONG_NM             AS belongNm,            /* 소속명  */
         DEPT_NM               AS deptNm,              /* 부서명  */
         POSITION_NM           AS positionNm,          /* 직책명  */
         FILE_ID               AS fileId,              /* 파일 ID  */
         LOGIN_FAIL_CNT        AS loginFailCnt,        /* 로그인 실패 회수  */
         LAST_LOGIN_TM         AS lastLoginDateTime,   /* 최근 로그인 일시  */
         FIRST_LOGIN_YN        AS firstLoginYn,        /* 첫 로그인 여부  */
         OTP_NO                AS otpNo,               /* OTP 발행번호  */
         OTP_ISSU_TM           AS otpIssuTm,           /* OTP 발생일시  */
         CRE_TM                AS creTm,               /* 등록 일시  */
         CRE_USER              AS creUser,             /* 생성자  */
         UPD_TM                AS updTm,               /* 수정 일시  */
         UPD_USER              AS updUser,             /* 수정자  */
         DEL_YN                AS deleteYn,            /* 삭제 여부  */
         USE_YN                AS useYn,               /* 사용 여부  */
         LOCK_YN               AS lockYn,              /* 계정 잠김 여부  */
         AUTH_CD               AS authCd,              /* 권한 코드  */
         USER_TYPE             AS userType             /* 사용자 유형  */
    </sql>



    <select id="selectUserListPaging" parameterType="com.shop.core.biz.common.vo.request.PageRequest" resultType="com.shop.core.biz.system.vo.response.UserResponse">
        /* com.shop.mapper.user.selectUserListPaging */
        SELECT ( COUNT(1) OVER() )                                                                          AS totalRowCount
            , ROW_NUMBER() OVER(ORDER BY ID ASC)                                                            AS no
            , TU.ID                                                                                         AS id
            , TU.LOGIN_ID                                                                                   AS loginId
            , TU.LOGIN_PASS                                                                                 AS loginPass
            , TU.USER_NM                                                                                    AS userNm
            , TU.AUTH_CD                                                                                    AS authCd
            , FN_GET_CODE('10020', TU.AUTH_CD)                                                              AS authNm
            , TU.PHONE_NO                                                                                   AS phoneNo
            , TU.BELONG_NM                                                                                  AS belongNm
            , TU.DEPT_NM                                                                                    AS deptNm
            , TU.POSITION_NM                                                                                AS positionNm
            , TU.LOGIN_FAIL_CNT                                                                             AS loginFailCnt
            , TU.LAST_LOGIN_TM                                                                              AS lastLoginTm
            , TU.FIRST_LOGIN_YN                                                                             AS firstLoginYn
            , TU.OTP_NO                                                                                     AS otpNo
            , TU.OTP_ISSU_TM                                                                                AS otpIssuTm
            , TU.CRE_TM                                                                                     AS creTm
            , FN_GET_USERNAME(TU.CRE_USER)                                                                  AS creUser
            , TU.UPD_TM                                                                                     AS updTm
            , (SELECT XU.USER_NM FROM TB_USER XU WHERE TU.UPD_USER = XU.LOGIN_ID)                           AS updUser
            , TU.DEL_YN                                                                                     AS deleteYn
            , TU.USER_TYPE                                                                                  AS userType
        FROM TB_USER TU
        WHERE 1 = 1
--           AND DEL_YN = 'N' // 삭제여부를 사용여부로 관리
        <if test='filter.authCd != null and !filter.authCd.equals("")'>
          AND TU.AUTH_CD = #{filter.authCd}
        </if>
        <if test='filter.userNm != null and !filter.userNm.equals("")'>
          AND TU.USER_NM LIKE '%' + #{filter.userNm} + '%'
        </if>
        <if test='filter.phoneNo != null and !filter.phoneNo.equals("")'>
          AND TU.PHONE_NO LIKE '%' + #{filter.phoneNo} + '%'
        </if>
        <if test='filter.belongNm != null and !filter.belongNm.equals("")'>
          AND TU.BELONG_NM LIKE '%' + #{filter.belongNm} + '%'
        </if>
        <if test='filter.deleteYn != null and !filter.deleteYn.equals("")'>
          AND TU.DEL_YN = #{filter.deleteYn}
        </if>
        <if test='filter.deptNm != null and !filter.deptNm.equals("")'>
          AND TU.DEPT_NM LIKE '%' + #{filter.deptNm} + '%'
        </if>
        <if test='filter.positionNm != null and !filter.positionNm.equals("")'>
          AND TU.POSITION_NM LIKE '%' + #{filter.positionNm} + '%'
        </if>
        ORDER BY TU.ID DESC
        OFFSET ((#{curPage}-1) * #{pageRowCount}) ROWS FETCH NEXT #{pageRowCount} ROWS ONLY
    </select>


    <select id="selectUserById" parameterType="Integer" resultType="com.shop.core.biz.system.vo.response.UserResponse$SelectByLoginId">
        /* com.shop.mapper.user.selectUserById */
        SELECT
        <include refid="userColumns" />
        , FN_GET_CODE('10020', TU.AUTH_CD) AS authNm
        , FN_GET_CODE('10020', TU.USER_TYPE) AS userTypeNm
        , FN_GET_USERNAME(TU.CRE_USER)     AS creUser
        , FN_GET_USERNAME(TU.UPD_USER)     AS updUser
        FROM TB_USER TU
        WHERE TU.ID = #{userId}
        AND TU.DEL_YN = 'N'
    </select>

    <select id="selectPartnerIdByUserId" parameterType="java.lang.Integer"  resultType="java.lang.Integer">
        /* com.shop.mapper.user.selectPartnerIdByUserId */
       SELECT PARTNER_ID
         FROM TB_USER
        WHERE ID = #{userId}
    </select>

    <select id="selectPartnerIdByLoginId" parameterType="java.lang.String"  resultType="java.lang.Integer">
        /* com.shop.mapper.user.selectPartnerIdByLoginId */
      SELECT PARTNER_ID
        FROM TB_USER
       WHERE LOGIN_ID = #{loginId}
         AND DEL_YN = 'N'
    </select>

    <select id="selectUserByLoginId" parameterType="String" resultType="com.shop.core.biz.system.vo.response.UserResponse$SelectByLoginId">
        /* com.shop.mapper.user.selectUserByLoginId */
        SELECT
              ID                    AS id
            , LOGIN_ID              AS loginId
            , USER_NM               AS userNm
            , AUTH_CD               AS authCd
            , USER_TYPE             AS userType
            , PARTNER_ID            AS partnerId
            , PHONE_NO              AS phoneNo
            , BELONG_NM             AS belongNm
            , DEPT_NM               AS deptNm
            , POSITION_NM           AS positionNm
            , FILE_ID               AS fileId
            , LOGIN_FAIL_CNT        AS loginFailCnt
            , LAST_LOGIN_TM         AS lastLoginDateTime
            , FIRST_LOGIN_YN        AS firstLoginYn
            , OTP_NO                AS otpNo
            , OTP_ISSU_TM           AS otpIssuTm
            , CRE_TM                AS creTm
            , UPD_TM                AS updTm
            , DEL_YN                AS deleteYn
            , USE_YN                AS useYn
            , LOCK_YN               AS lockYn
            , AUTH_CD               AS authCd
            , FN_GET_USERNAME(TU.LOGIN_ID)                           AS creUserNm
            , FN_GET_USERNAME(TU.UPD_USER)                           AS updUserNm
            , 0 AS otpSecond
            , FN_GET_CODE('10020', TU.AUTH_CD) AS authNm
            , FN_GET_CODE('10020', TU.USER_TYPE) AS userTypeNm
            , IS_MOBILE_LOGIN
        FROM TB_USER TU
        WHERE LOGIN_ID = #{loginId}
          AND DEL_YN = 'N'
    </select>


    <select id="selectUserByLoginIdForLogin" parameterType="String" resultType="com.shop.core.biz.system.vo.response.UserResponse$SelectByLoginId">
        /* com.shop.mapper.user.selectUserByLoginIdForLogin */
        SELECT
            ID                    AS id
             , LOGIN_ID              AS loginId
             , LOGIN_PASS            AS loginPass
             , USER_NM               AS userNm
             , AUTH_CD               AS authCd
             , USER_TYPE             AS userType
             , PARTNER_ID            AS partnerId
             , PHONE_NO              AS phoneNo
             , BELONG_NM             AS belongNm
             , DEPT_NM               AS deptNm
             , POSITION_NM           AS positionNm
             , FILE_ID               AS fileId
             , LOGIN_FAIL_CNT        AS loginFailCnt
             , LAST_LOGIN_TM         AS lastLoginDateTime
             , FIRST_LOGIN_YN        AS firstLoginYn
             , OTP_NO                AS otpNo
             , OTP_ISSU_TM           AS otpIssuTm
             , CRE_TM                AS creTm
             , UPD_TM                AS updTm
             , DEL_YN                AS deleteYn
             , USE_YN                AS useYn
             , LOCK_YN               AS lockYn
             , AUTH_CD               AS authCd
             , FN_GET_USERNAME( TU.CRE_USER) AS creUser
             , FN_GET_USERNAME(TU.UPD_USER) AS updUser
             , 0 AS otpSecond
             , FN_GET_CODE('10020', TU.AUTH_CD) AS authNm
             , FN_GET_CODE('10020', TU.USER_TYPE) AS userTypeNm
        FROM TB_USER TU
        WHERE LOGIN_ID = #{loginId}
          AND DEL_YN = 'N'
    </select>

    <select id="selectUserByUk" parameterType="String" resultType="com.shop.core.biz.system.vo.response.UserResponse$SelectByLoginId">
        /* com.shop.mapper.user.selectUserByUk */
        SELECT
        <include refid="userColumns" />
        , 0 AS otpSecond
        FROM TB_USER TU
        WHERE (LOGIN_ID = #{loginId} OR USER_NM = #{userNm})
        AND DEL_YN = 'N'
    </select>

    <insert id="insertUser" parameterType="com.shop.core.entity.User" useGeneratedKeys="true" keyProperty="id">
        /* com.shop.mapper.user.insertUser */
        INSERT INTO TB_USER
        (
              LOGIN_ID
            , LOGIN_PASS
        <if test="partnerId != null">
            , PARTNER_ID
        </if>
            , USER_NM
            , AUTH_CD
            , USER_TYPE
            , PHONE_NO
            , BELONG_NM
        <if test="deptNm != null">
            , DEPT_NM
        </if>
        <if test="positionNm != null">
            , POSITION_NM
        </if>
            , LOGIN_FAIL_CNT
            , LAST_LOGIN_TM
            , FIRST_LOGIN_YN
            , LAST_PASS_CHG_TM
            , CRE_USER
            , UPD_USER
        <if test="isMobileLogin != null">
            , IS_MOBILE_LOGIN
        </if>
        ) VALUES (
              #{loginId}
            , #{loginPass}
        <if test="partnerId != null">
            , #{partnerId}
        </if>
            , #{userNm}
            , #{authCd}
            , #{userType}
            , #{phoneNo}
            , #{belongNm}
        <if test="deptNm != null">
            , #{deptNm}
        </if>
        <if test="positionNm != null">
            , #{positionNm}
        </if>
            , 0
            , now()
            , 'N'
            , now()
            , #{creUser}
            , #{creUser}
        <if test="isMobileLogin != null">
            , #{isMobileLogin}
        </if>
        )
    </insert>

    <update id="updateUser" parameterType="com.shop.core.entity.User">
        /* com.shop.mapper.user.updateUser */
        UPDATE TB_USER
            SET UPD_TM   = NOW()
              , UPD_USER = #{updUser}
            <if test="loginId != null">
                , LOGIN_ID = #{loginId}
            </if>
            <if test="loginPass != null">
                , LOGIN_PASS = #{loginPass}
            </if>
            <if test="userNm != null">
              , USER_NM = #{userNm}
            </if>
            <if test="authCd != null">
                , AUTH_CD = #{authCd}
            </if>
            <if test="userType != null">
                , USER_TYPE = #{userType}
            </if>
            <if test="phoneNo != null">
              , PHONE_NO = #{phoneNo}
            </if>
            <if test="belongNm != null">
              , BELONG_NM = #{belongNm}
            </if>
            <if test="deptNm != null">
              , DEPT_NM = #{deptNm}
            </if>
            <if test="positionNm != null">
              , POSITION_NM = #{positionNm}
            </if>
            <if test="loginFailCnt != null">
              , LOGIN_FAIL_CNT = #{loginFailCnt}
            </if>
            <if test="lastLoginDateTime != null">
              , LAST_LOGIN_TM = #{lastLoginDateTime}
            </if>
            <if test="firstLoginYn != null">
              , FIRST_LOGIN_YN = #{firstLoginYn}
            </if>
            <if test="deleteYn != null">
              , DEL_YN = #{deleteYn}
            </if>
            <if test="useYn != null">
                , USE_YN = #{useYn}
            </if>
            <if test="fileId != null">
                , FILE_ID = #{fileId}
            </if>
            <if test="isMobileLogin != null">
                , IS_MOBILE_LOGIN = #{isMobileLogin}
            </if>
        WHERE ID = #{id}
    </update>

    <update id="updateUserPartnerId" parameterType="com.shop.core.entity.User">
        /* com.shop.mapper.user.updateUserPartnerId */
        UPDATE TB_USER
        SET UPD_TM   = NOW()
          , UPD_USER = #{updUser}
          , PARTNER_ID = #{partnerId}
        WHERE ID = #{id}
    </update>


    <delete id="deleteUser" parameterType="com.shop.core.entity.User">
        /* com.shop.mapper.user.deleteUser */
        DELETE
        FROM TB_USER
        WHERE ID = #{id}
    </delete>

    <update id="updateOtpNo" parameterType="com.shop.core.entity.User">
        /* com.shop.mapper.user.updateOtpNo */
        UPDATE TB_USER
        SET UPD_TM   = NOW()
          , UPD_USER = #{updUser}
          , OTP_ISSU_TM   = NOW()
          , OTP_NO   = #{otpNo}
        WHERE ID = #{id}
    </update>


    <select id="selectUserPaging" parameterType="com.shop.core.biz.common.vo.request.PageRequest" resultType="com.shop.core.biz.system.vo.response.UserResponse$Paging">
        /* com.shop.mapper.user.selectUserPaging */
        SELECT
              TU.ID AS id
            , TU.LOGIN_ID AS loginId
            , TU.LOGIN_PASS AS loginPass
            , TU.USER_NM AS userNm
            , TU.AUTH_CD AS authCd
            , TU.PARTNER_ID AS partnerId
            , TU.PHONE_NO AS phoneNo
            , TU.BELONG_NM AS belongNm
            , TU.DEPT_NM AS deptNm
            , TU.POSITION_NM AS positionNm
            , TU.LOGIN_FAIL_CNT AS loginFailCnt
            , TU.LAST_LOGIN_TM AS lastLoginDateTime
            , TU.FIRST_LOGIN_YN AS firstLoginYn
            , TU.OTP_NO AS otpNo
            , TU.OTP_ISSU_TM AS otpIssuTm
            , TU.CRE_TM AS creTm
            , TU.CRE_USER AS creUser
            , TU.UPD_TM AS updTm
            , TU.UPD_USER AS updUser
            , TU.DEL_YN AS deleteYn
            , TU.USE_YN AS useYn
            , TU.LOCK_YN AS lockYn
            , TU.AUTH_CD AS authCd
            , TU.USER_TYPE AS userType
            , ( COUNT(1) OVER() )                                                                               AS totalRowCount
            , ROW_NUMBER() OVER(ORDER BY TU.ID ASC)                                                             AS no
            , TU.PHONE_NO                                                                                       AS phoneN        FROM TB_USER TU
        <if test="filter.partnerId != null and !filter.partnerId.equals('')">
            LEFT JOIN TB_PARTNER TP ON TU.PARTNER_ID = TP.ID
        </if>
        WHERE TU.DEL_YN = 'N'
            <if test='filter.omsWmsTp != null and filter.omsWmsTp.equals("0")'>
                AND TU.AUTH_CD::integer <![CDATA[<]]> 400
            </if>
            <if test='filter.omsWmsTp != null and filter.omsWmsTp.equals("W")'>
                AND TU.AUTH_CD::integer <![CDATA[>]]> 399
            </if>
            <if test='filter.partnerId != null and !filter.partnerId.equals("")'>
                AND TU.PARTNER_ID =  #{filter.partnerId}
            </if>
            <if test='filter.loginId != null and !filter.loginId.equals("")'>
                AND TU.LOGIN_ID LIKE '%' || #{filter.loginId} || '%'
            </if>
            <if test='filter.userNm != null and !filter.userNm.equals("")'>
                AND TU.USER_NM LIKE '%' || #{filter.userNm} || '%'
            </if>
            <if test='filter.authCd == null or filter.authCd.equals("")'>
                AND TU.AUTH_CD <![CDATA[<=]]> #{filter.myAuthCd}
            </if>
            <if test='filter.authCd != null and !filter.authCd.equals("")'>
                AND TU.AUTH_CD = #{filter.authCd}
            </if>
            <if test='filter.phoneNo != null and !filter.phoneNo.equals("")'>
                AND TU.PHONE_NO LIKE '%' || #{filter.phoneNo} || '%'
            </if>
            <if test='filter.compNm != null and !filter.compNm.equals("")'>
                AND TU.COMP_ID = (SELECT TP.ID FROM TB_COMP TP WHERE TP.COMP_NAME LIKE '%' || #{filter.compNm} || '%')
            </if>
            <if test='filter.belongNm != null and !filter.belongNm.equals("")'>
                AND TU.BELONG_NM LIKE '%' || #{filter.belongNm} || '%'
            </if>
            <if test='filter.deptNm != null and !filter.deptNm.equals("")'>
                AND TU.DEPT_NM LIKE '%' || #{filter.deptNm} || '%'
            </if>
            <if test='filter.positionNm != null and !filter.positionNm.equals("")'>
                AND TU.POSITION_NM LIKE '%' || #{filter.positionNm} || '%'
            </if>
            <if test='filter.useYn != null and !filter.useYn.equals("")'>
                AND TU.USE_YN = #{filter.useYn}
            </if>
            <if test='filter.excludeIds != null and filter.excludeIds.size > 0'>
                AND TU.ID NOT IN
                <foreach collection="filter.excludeIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
        ORDER BY TU.ID DESC
        OFFSET ((#{curPage}-1) * #{pageRowCount}) ROWS FETCH NEXT #{pageRowCount} ROWS ONLY
    </select>

    <select id="selectUserByLoginIdCountryCode" parameterType="java.util.HashMap" resultType="com.shop.core.biz.system.vo.response.UserResponse$SelectByLoginId">
        /* com.shop.mapper.user.selectUserByLoginIdCountryCode */
        SELECT
            <include refid="userColumns" />
        FROM TB_USER TU
        WHERE 1 = 1
        AND TU.DEL_YN = 'N'
        AND TU.LOGIN_ID = #{loginId}
    </select>

    <update id="updatePassword" parameterType="com.shop.core.entity.User">
        /* com.shop.mapper.user.updatePassword */
        UPDATE TB_USER
        SET UPD_TM = NOW()
            , UPD_USER = #{updUser}
            , FIRST_LOGIN_YN = #{firstLoginYn}
            , LOGIN_FAIL_CNT = 0
            , LOGIN_PASS = #{loginPass}
        <if test='lockYn != null and !lockYn.equals("")'>
            , LOCK_YN = #{lockYn}
        </if>
            , LAST_PASS_CHG_TM = NOW()
        WHERE ID = #{id}
    </update>

    <update id="updatePasswordInit" parameterType="com.shop.core.entity.User">
        UPDATE TB_USER
        SET LOGIN_PASS = #{loginPass}
            , FIRST_LOGIN_YN = 'N'
            , UPD_TM = NOW()
            , UPD_USER = #{updUser}
            , LOGIN_FAIL_CNT = 0
            , LAST_PASS_CHG_TM = NOW()
        WHERE ID = #{id}
    </update>

    <update id="updateUserUnLock">
        UPDATE TB_USER
        SET LOCK_YN = 'N'
          , UPD_TM = NOW()
          , UPD_USER = #{updUser}
          , LOGIN_FAIL_CNT = 0
          , LAST_PASS_CHG_TM = NOW()
        WHERE ID = #{id}
    </update>

    <select id="selectDesinerUserList" parameterType="map" resultType="com.shop.core.entity.User">
        SELECT ROW_NUMBER() OVER(ORDER BY ID ASC),
        <include refid="userColumns" />
        FROM TB_USER
        WHERE PARTNER_ID = #{partnerId}
        <if test="authCd != null">
            AND AUTH_CD = #{authCd}
        </if>
    </select>

</mapper>

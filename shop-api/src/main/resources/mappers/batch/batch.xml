<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.mapper.batch">

    <select id="selectAsnColumns" parameterType="String" resultType="String">
        /* com.shop.mapper.batch.selectAsnColumns */
        SELECT column_name
          FROM information_schema.columns
         WHERE UPPER(table_name) = 'TB_ASN'
           AND UPPER(column_name) NOT IN ('ID','GEN_CNT','ASN_CNT','OUT_YMD','PARENT_ID', 'ASN_STAT_CD', 'ASN_ORIGIN', 'CRE_USER', 'CRE_TM', 'UPD_USER', 'UPD_TM')
    </select>

    <select id="selectAsnCountByParentId" resultType="java.lang.Integer">
        /* [하위 발주건수 조회] com.shop.mapper.batch.selectAsnCountByParentId */
        SELECT COUNT(1)
          FROM TB_ASN
         WHERE PARENT_ID = #{parentId}
    </select>

    <insert id="insertAsnForBatch">
        /* [입하잔량 발주생성] com.shop.mapper.batch.insertAsnForBatch */
        INSERT INTO TB_ASN
        (
        <foreach collection="columns" item="column" separator=",">
            ${column}
        </foreach>
        , GEN_CNT
        , ASN_CNT
        , OUT_YMD
        , PARENT_ID
        , ASN_STAT_CD
        , ASN_ORIGIN
        , CRE_USER
        , CRE_TM
        , UPD_USER
        , UPD_TM
        )
        SELECT
            <foreach collection="columns" item="column" separator=",">
               A.${column}
            </foreach>
             , A.GEN_CNT - S.STOCK_CNT
             , 0
             , NULL
             , A.ID   /* 참조아이디로 사용(parentId) */
             , '2'    /* 발주확정처리 */
             , '잔량'
             , 'SYSTEM'
             , NOW()
             , 'SYSTEM'
             , NOW()
         FROM TB_ASN A
         JOIN TB_STOCK S ON A.ID = S.ASN_ID
        WHERE A.ID = #{asnId}
    </insert>

    <insert id="insertBatchLog" parameterType="com.shop.core.entity.Batch">
        /* [배치로그생성] com.shop.mapper.batch.insertBatchLog */
        INSERT INTO TB_BATCH
        (
          BATCH_TP
        , START_TM
        , END_TM
        , TARGET_CNT
        , TRAN_CNT
        , FAIL_CNT
        , RSLT_CD
        , MESSAGE
        )
        VALUES
        (
          #{batchTp}
        , #{startTm}
        , #{endTm}
        , #{targetCnt}
        , #{tranCnt}
        , #{failCnt}
        , #{rsltCd}
        , #{message}
        )
    </insert>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.mapper.history">

    <select id="selectColumns" parameterType="String" resultType="String">
        /* com.shop.mapper.user.selectColumns */
        SELECT column_name
        FROM information_schema.columns
        WHERE UPPER(table_name) = UPPER(#{tableName})
          AND UPPER(column_name) NOT IN ('ID','DEL_YN','BEF_ID','CRE_TM','UPD_TM')
    </select>

    <select id="selectColumnsForSame" parameterType="String" resultType="String">
        /* com.shop.mapper.user.selectColumns */
        SELECT column_name
        FROM information_schema.columns
        WHERE UPPER(table_name) = UPPER(#{tableName})
          AND UPPER(column_name) NOT IN ('ID','DEL_YN','BEF_ID','CRE_USER','UPD_USER','CRE_TM','UPD_TM')
    </select>

    <insert id="insertHistory" useGeneratedKeys="true" keyProperty="id">
        /* com.shop.mapper.user.insertHistory */
        INSERT INTO ${tableName} (
        <foreach collection="columns" item="column" separator=",">
            ${column}
        </foreach>
        , DEL_YN
        , BEF_ID
        )
        SELECT
        <foreach collection="columns" item="column" separator=",">
            A.${column}
        </foreach>
        , 'Y'
        , #{befId}
        FROM ${tableName} A
        WHERE ID = #{befId}
        RETURNING id
    </insert>

    <select id="checkChangeData" resultType="java.lang.Integer">
        /* com.shop.mapper.user.checkChangeData */
        SELECT COUNT(*)
        FROM (
            SELECT
            <foreach collection="columns" item="column" separator=",">
                ${column}
            </foreach>
            FROM ${tableName} WHERE ID = #{befId}
                UNION
                SELECT
            <foreach collection="columns" item="column" separator=",">
                ${column}
            </foreach>
            FROM ${tableName} WHERE ID = ( SELECT MAX(ID) FROM ${tableName} WHERE BEF_ID = #{befId} )
        ) AS COMPARE_TABLE
    </select>

    <select id="getImportantColumn" resultType="java.lang.String">
        /* com.shop.mapper.user.getImportantColumn */
        SELECT CODE_ETC_1
          FROM TB_CODE
         WHERE CODE_UPPER = '50040'
           AND CODE_CD = #{tableName}
           AND DEL_YN = 'N'
         LIMIT 1
    </select>

    <delete id="deleteHistory">
        /* com.shop.mapper.user.deleteHistory 주요 변경사항이 없는 이력은 지운다.*/
        DELETE FROM ${tableName} WHERE ID = #{insId}
    </delete>
</mapper>
